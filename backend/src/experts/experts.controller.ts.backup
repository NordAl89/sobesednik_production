import { 
  Controller, 
  Get, 
  Post, 
  Body, 
  Param, 
  Delete, 
  UnauthorizedException,
  Patch,
  UseInterceptors,
  UploadedFiles
} from '@nestjs/common';
import { FileFieldsInterceptor } from '@nestjs/platform-express';
import { ExpertsService } from './experts.service';
import { CreateExpertDto } from './dto/create-expert.dto';
import { LoginExpertDto } from './dto/login-expert.dto';

@Controller('experts')
export class ExpertsController {
  constructor(private readonly expertsService: ExpertsService) {}

  @Patch(':id')
  async update(
    @Param('id') id: string, 
    @Body() updateExpertDto: any
  ) {
    console.log('üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞:', id, updateExpertDto);
    
    const expert = await this.expertsService.update(id, updateExpertDto);
    console.log('‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:', expert);
    
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      alwaysAvailable: expert.alwaysAvailable,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  // –í–ê–ñ–ù–û: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–ï–†–ï–î –æ–±—â–∏–º–∏
  @Post('with-files')
  @UseInterceptors(
    FileFieldsInterceptor([
      { name: 'mainPhoto', maxCount: 1 },
      { name: 'gallery', maxCount: 10 }
    ], {
      limits: {
        fileSize: 10 * 1024 * 1024, // 10MB limit
      },
      fileFilter: (req, file, cb) => {
        if (file.mimetype.startsWith('image/') || file.mimetype.startsWith('video/')) {
          cb(null, true);
        } else {
          cb(new Error('Only images and videos are allowed'), false);
        }
      },
    })
  )
  async createWithFiles(
    @UploadedFiles() files: { mainPhoto?: Express.Multer.File[], gallery?: Express.Multer.File[] },
    @Body() createExpertDto: any // –ò–∑–º–µ–Ω–µ–Ω–æ —Å CreateExpertDto –Ω–∞ any –¥–ª—è FormData
  ) {
    console.log('üì® –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å —Å —Ñ–∞–π–ª–∞–º–∏:', createExpertDto);
    console.log('üìÅ –§–∞–π–ª—ã:', files);

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–∑ FormData –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã
    const normalizedDto = {
      ...createExpertDto,
      age: parseInt(createExpertDto.age),
      price: parseFloat(createExpertDto.price),
      adultTopics: createExpertDto.adultTopics === 'true',
      noForbiddenTopics: createExpertDto.noForbiddenTopics === 'true',
      alwaysAvailable: createExpertDto.alwaysAvailable === 'true',
      publicationDays: parseInt(createExpertDto.publicationDays || '30'),
      paymentAmount: parseFloat(createExpertDto.paymentAmount || '0'),
    };

    console.log('üîÑ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', normalizedDto);

    const mainPhoto = files?.mainPhoto?.[0];
    const galleryFiles = files?.gallery || [];

    const expert = await this.expertsService.createWithFiles(
      normalizedDto, 
      mainPhoto, 
      galleryFiles
    );

    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      telegram: expert.telegram,
      otherMessengers: expert.otherMessengers,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      galleryUrls: expert.galleryUrls ? JSON.parse(expert.galleryUrls) : [],
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      status: expert.status,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount,
      createdAt: expert.createdAt
    };
  }

  @Post()
  async create(@Body() createExpertDto: CreateExpertDto) {
    console.log('üì® –ü–æ–ª—É—á–µ–Ω POST –∑–∞–ø—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º–∏:', createExpertDto);
    
    const expert = await this.expertsService.create(createExpertDto);
    console.log('‚úÖ –°–æ–∑–¥–∞–Ω —ç–∫—Å–ø–µ—Ä—Ç:', expert);
    
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      galleryUrls: expert.galleryUrls,
      createdAt: expert.createdAt,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      alwaysAvailable: expert.alwaysAvailable,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  @Post('login')
  async login(@Body() loginExpertDto: LoginExpertDto) {
    console.log('üö™ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Ö–æ–¥:', loginExpertDto)
    
    const expert = await this.expertsService.validateExpert(
      loginExpertDto.login,
      loginExpertDto.password
    );

    if (!expert) {
      console.log('‚ùå –í—Ö–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ')
      throw new UnauthorizedException('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    }

    console.log('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–∞:', expert.name)
    
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      alwaysAvailable: expert.alwaysAvailable,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  @Post(':id/update')
  async updateViaPost(
    @Param('id') id: string, 
    @Body() updateExpertDto: any
  ) {
    console.log('üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞ —á–µ—Ä–µ–∑ POST:', id, updateExpertDto);
    
    const expert = await this.expertsService.update(id, updateExpertDto);
    console.log('‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:', expert);
    
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      alwaysAvailable: expert.alwaysAvailable,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  // üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–Ω–∫–µ—Ç—ã –∞–¥–º–∏–Ω–æ–º
  @Post('admin/:id/block')
  async blockExpert(@Param('id') id: string) {
    console.log('üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–Ω–∫–µ—Ç—ã —ç–∫—Å–ø–µ—Ä—Ç–∞:', id);

    const expert = await this.expertsService.blockExpert(id);

    console.log('‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', expert);

    return {
      id: expert.id,
      status: expert.status,
      adminVerified: expert.adminVerified
    };
  }

  @Get('profile/:id')
  async getProfile(@Param('id') id: string) {
    const expert = await this.expertsService.getProfile(id);
    
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adminVerified: expert.adminVerified,
      status: expert.status,
      telegram: expert.telegram,
      otherMessengers: expert.otherMessengers,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      createdAt: expert.createdAt,
      alwaysAvailable: expert.alwaysAvailable,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  // Endpoint –¥–ª—è –∞–¥–º–∏–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
  // –í–ê–ñ–ù–û: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î @Get() –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
  @Get('admin/all')
  async findAllForAdmin() {
    console.log('üîç –ó–∞–ø—Ä–æ—Å –∫ /experts/admin/all');
    const experts = await this.expertsService.findAll();
    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞: ${experts.length}`);
    return experts.map(expert => ({
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      status: expert.status,
      adminVerified: expert.adminVerified,
      telegram: expert.telegram,
      otherMessengers: expert.otherMessengers,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      paymentCode: expert.paymentCode,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount,
      createdAt: expert.createdAt,
      updatedAt: expert.updatedAt,
      alwaysAvailable: expert.alwaysAvailable
    }));
  }

  @Get()
  async findAll() {
    console.log('üîç –ó–∞–ø—Ä–æ—Å –∫ /experts (–ø—É–±–ª–∏—á–Ω—ã–π endpoint)');
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    const experts = await this.expertsService.findAllActive();
    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤: ${experts.length}`);
    return experts.map(expert => ({
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      gender: expert.gender,
      availability: expert.availability,
      about: expert.about,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      status: expert.status,
      adminVerified: expert.adminVerified,
      telegram: expert.telegram,
      otherMessengers: expert.otherMessengers,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      createdAt: expert.createdAt,
      updatedAt: expert.updatedAt,
      alwaysAvailable: expert.alwaysAvailable
    }));
  }

  @Get('debug/:id')
  async debugExpert(@Param('id') id: string) {
    const expert = await this.expertsService.findOne(id);
    return {
      rawData: expert,
      createdAt: expert.createdAt,
      createdAtType: typeof expert.createdAt,
      login: expert.login
    };
  }

  @Get(':id')
  async findOne(@Param('id') id: string) {
    const expert = await this.expertsService.findOne(id);
    return {
      id: expert.id,
      login: expert.login,
      name: expert.name,
      age: expert.age,
      availability: expert.availability,
      about: expert.about,
      allowedTopics: expert.allowedTopics,
      forbiddenTopics: expert.forbiddenTopics,
      price: expert.price,
      mainPhotoUrl: expert.mainPhotoUrl,
      galleryUrls: expert.galleryUrls,
      rating: expert.rating,
      totalSessions: expert.totalSessions,
      adminVerified: expert.adminVerified,
      status: expert.status,
      telegram: expert.telegram,
      otherMessengers: expert.otherMessengers,
      adultTopics: expert.adultTopics,
      noForbiddenTopics: expert.noForbiddenTopics,
      paymentCode: expert.paymentCode,
      createdAt: expert.createdAt,
      alwaysAvailable: expert.alwaysAvailable,
      publicationDays: expert.publicationDays,
      paymentAmount: expert.paymentAmount
    };
  }

  @Delete(':id')
  async remove(@Param('id') id: string) {
    await this.expertsService.remove(id);
    return { message: '–≠–∫—Å–ø–µ—Ä—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω' };
  }

  @Post(':id/moderation')
  async requestModeration(@Param('id') id: string) {
    console.log('üìã –ó–∞–ø—Ä–æ—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–∞:', id);
    
    const expert = await this.expertsService.requestModeration(id);
    console.log('‚úÖ –°—Ç–∞—Ç—É—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω:', expert);
    
    return {
      id: expert.id,
      status: expert.status,
      adminVerified: expert.adminVerified
    };
  }

  // –û–¥–æ–±—Ä–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞
  @Post('admin/:id/approve')
  async approveExpert(@Param('id') id: string) {
    console.log('‚úÖ –û–¥–æ–±—Ä–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞:', id);
    
    const expert = await this.expertsService.approveExpert(id);
    console.log('‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –æ–¥–æ–±—Ä–µ–Ω:', expert);
    
    return {
      id: expert.id,
      status: expert.status,
      adminVerified: expert.adminVerified,
      publishedAt: expert.publishedAt,
      expiresAt: expert.expiresAt
    };
  }

  // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞
  @Post('admin/:id/reject')
  async rejectExpert(
    @Param('id') id: string,
    @Body() body: { reason: string }
  ) {
    console.log('‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞:', id, '–ü—Ä–∏—á–∏–Ω–∞:', body.reason);
    
    const expert = await this.expertsService.rejectExpert(id, body.reason);
    console.log('‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω:', expert);
    
    return {
      id: expert.id,
      status: expert.status
    };
  }
// —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–µ–ª–µ–≥—Ä–∞–º
  @Post(':id/notify')
async notifyExpert(@Param('id') id: string, @Body('message') message: string) {
  await this.expertsService.notifyExpertViaTelegram(id, message);
  return { success: true };
}
}